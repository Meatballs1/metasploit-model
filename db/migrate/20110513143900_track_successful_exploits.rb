# Adds vulns.exploited_at.
class TrackSuccessfulExploits < ActiveRecord::Migration
  # Model to help migrated vulns.exploited_at out of exploited_hosts.
  class ExploitedHost < ActiveRecord::Base
  end

  # Model to help find import vulns.exploited_at.
  class Vuln < ActiveRecord::Base
  end

  # Removes vulns.exploited_at.
  #
  # @return [void]
  def down
    remove_column :vulns, :exploited_at
  end

  # Adds vulns.exploited_at.
  #
  # @return [void]
  def up
    add_column :vulns, :exploited_at, :timestamp

    # Migrate existing exploited_hosts entries

    ExploitedHost.find(:all).select {|x| x.name}.each do |exploited_host|
      next unless(exploited_host.name =~ /^(exploit|auxiliary)\//)
      vulns = Vuln.find_all_by_name_and_host_id(exploited_host.name, exploited_host.host_id)
      next if vulns.empty?
      vulns.each do |vuln|
        vuln.exploited_at = exploited_host.updated_at
        vuln.save
      end
    end
  end
end
